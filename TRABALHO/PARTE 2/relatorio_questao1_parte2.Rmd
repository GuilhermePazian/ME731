---
title: 
geometry: textwidth=18cm,textheight=24cm
header-includes:
- \usepackage{setspace}
- \usepackage{indentfirst}
- \usepackage[utf8]{inputenc}
- \usepackage{mathptmx}
- \usepackage{enumerate}
- \usepackage{url}
- \usepackage{float}
- \usepackage{lipsum}
- \usepackage{multirow}
- \usepackage{booktabs}
- \usepackage{longtable}
- \usepackage{subcaption}
output:
  pdf_document: 
    number_sections: true
  html_document: default
  mainfont: Times New Roman
  fig_caption: yes
lang: pt-br
setspace: doublespacing
fontsize: 10pt
---

\begin{titlepage}
\thispagestyle{empty}
\begin{center}
\begin{center}
\begin{minipage}[s]{1.75cm}
\includegraphics[width=40pt,height=45pt]{logoUnicamp.png} 
\end{minipage}\begin{minipage}[s]{11.25cm}\noindent
{\begin{center} {\Large Universidade Estadual de Campinas}\\
{Instituto de Matemática, Estatística e Computação Científica}\\
{\sc Departamento de Estatística}
\end{center}}
\end{minipage}
\begin{minipage}[s]{0.5cm}
\includegraphics[width=40pt,height=45pt]{logoimecc.png}
\end{minipage}
\end{center}
\end{center}
\vspace{3cm}
\font\fontGrande=cmcsc10 scaled 2500
\font\pessoal=cmr9 scaled 2500

\begin{center}
\vspace*{3.5cm}
{\rule[0 ex]{16cm}{0.05cm}}
{\huge \sc Trabalho - Parte 2 \\[8pt]
Relatório - Questão 1}
{\rule[0 ex]{16cm}{0.05cm}}
\end{center}

\begin{center}

\normalsize \vspace{8mm}


\vspace{4cm}

{\sc  Eliane Ramos de Siqueira  RA:155233} \\
{\sc  Guilherme Pazian  RA:160323}\\
{\sc  Henrique Capatto  RA:146406}\\
{\sc  Murilo Salgado Razoli  RA:150987}

\vspace{0.2cm}

Disciplina: {\bf ME731 - Análise Multivariada}\\
Professor: {\bf Caio Lucidius Naberezny Azevedo}
\vspace{1cm}

{\footnotesize{Campinas - SP \\ 24 de Novembro de 2017}}
\end{center}
\end{titlepage}

```{r echo=FALSE}
#mudando o separador decimal para resultados "printados"
options(OutDec= ",")
```

```{r, echo=FALSE}
#definindo opções padrões dos chunks
knitr::opts_chunk$set(fig.align='center', echo=FALSE, warning=FALSE, message=FALSE)
```


```{r pacotes,cache = FALSE,echo=FALSE, warning = FALSE,eval=TRUE,message = FALSE, error = FALSE}
#eval= FALSE faz com que o R ignore este chunk
#echo = FALSE não permite que o chunk apareça no pdf

#pacotes = c("tidyverse","reshape2","knitr","captioner","gdata","gridExtra","Matrix","plotrix","xtable")

packages= c("tidyverse","data.table","reshape2","captioner","gridExtra","caret","e1071","MASS","psych","xtable","corrplot","scales","knitr","kableExtra","formattable")


#install.packages(packages)

#mostra quais pacotes foram carregados
invisible(lapply(packages, require, character.only = TRUE))

figs <- captioner(prefix="Figura")
tbls <- captioner(prefix="Tabela")

#instalacao de um pacote pra "printar" tabelas mais bonitinhas
#install.packages('printr',type = 'source',repos = c('http://yihui.name/xran', 'http://cran.rstudio.com'))

```

```{r dados}
path_arq = glue::glue(getwd(),'/dados_salmao.txt')

dados = read.table(path_arq)

# descrição das colunas  
# procedência (1 - Alasca, 2 - Canadá), 
# gênero (1 - fêmea, 2 - macho), 
# diâmetro das guelras durante a fase em água doce (em mm), diâmetro das guelras durante a fase no mar (em mm)


# renomeando as colunas (Está na ordem do banco)
names(dados) = c("Reg","Gen","DGAD","DGM") #Reg=região, Gen=Gênero, DGAD=diâmetro das guelras durante a fase em água doce (em mm), DGM= diâmetro das guelras durante a fase no mar (em mm)

# fiz este data frame para manipulação na função dscrmnante

dados2 = dados
# Renomeando as variáves
dados$Reg =  as.factor(ifelse(dados$Reg==1,"Alasca","Canadá"))
dados$Gen =  as.factor(ifelse(dados$Gen==1,"fêmea","macho"))
```

```{r ana_descr}

source("funcoes_eli.r")

resumo_DGAD_regiao=tabela.descritiva_regiao(dados2$DGAD)
resumo_DGM_regiao=tabela.descritiva_regiao(dados2$DGM)

tab_resumo_regiao=rbind(resumo_DGAD_regiao, resumo_DGM_regiao)
#medidas resumo por genero

resumo_DGAD_genero=tabela.descritiva_genero(dados2$DGAD)
resumo_DGM_genero=tabela.descritiva_genero(dados2$DGM)

tab_resumo_genero=rbind(resumo_DGAD_genero, resumo_DGM_genero)
```

```{r}
############################Gráficos de boxplot#################################
# Boxplot de cada variável com relação a região
b1 = dados %>% ggplot(aes(Reg, DGAD))+stat_boxplot(geom ='errorbar')+geom_boxplot()+theme_bw()
b2 = dados %>% ggplot(aes(Reg, DGM))+stat_boxplot(geom ='errorbar')+geom_boxplot()+theme_bw()


############################Gráficos de dispersão#####################################
library(grid)

d1 <- dados %>% ggplot(aes(DGAD,  DGM, col =Reg)) + geom_point() +
    scale_colour_manual(values = c("Blue", "Red")) + 
    geom_smooth(method=lm,  
                se=FALSE) + theme_bw()+guides(col=F) + labs(x="Fase em água doce (em mm)", y = "Fase no
mar (em mm)")

d2 <- dados %>% ggplot(aes(DGAD,  DGM)) + geom_point(aes(color = Reg)) +
      scale_colour_manual(values = c("Blue", "Red")) + 
      geom_smooth(method=lm,  
                se=FALSE) + theme_bw()+ labs(x="Fase em água doce (em mm)", y = "Fase no
mar (em mm)")


####################GRAFICOS DE DENSIDADE########################################
g1 <- dados %>% ggplot(aes(x = DGAD)) +
        geom_density(aes(fill=factor(Reg)),position="identity", alpha=0.5) + theme(legend.position = "bottom") +
        theme_bw() + labs(y = "Valores ", x = "Valores doce", fill = "Espécies\n")+  scale_fill_brewer(palette="Accent")+guides(fill=F)

g2 <- dados %>% ggplot(aes(x = DGM)) +
        geom_density(aes(fill=factor(Reg)),position="identity", alpha=0.5) + theme(legend.position = "bottom") +
        theme_bw() + labs(y = "Valores", x = "Valores do Mar", fill = "Espécies\n")+  scale_fill_brewer(palette="Accent")+labs(fill = "Grupos")

```


```{r}
###################GRAFICO DE QUANTIL-QUANTIL - BIVARIADA###################
mx<- dados %>% filter(Reg=="Alasca")
n <- nrow(mx)
mx <- as.matrix(mx[,3:4])
vmu<-apply(mx,2,mean)
s2 <- cov(mx)
vvar<-diag(s2)
nvar<-2

mx2<- dados %>% filter(Reg=="Canadá")
n2 <- nrow(mx2)
mx2 <- as.matrix(mx2[,3:4])
vmu2 <-apply(mx2,2,mean)
s22 <- cov(mx2)
vvar2<-diag(s22)
nvar2<-2


mmu <- t(matrix(t(vmu),nvar,n))
mmu2 <- t(matrix(t(vmu2),nvar2,n2))

vF <- apply(((mx-vmu)*(mx-vmu)%*%solve(s2)),1,sum)
vF<- (n-nvar)*vF/((n-1)*nvar)

vF2 <- apply(((mx2-vmu2)*(mx2-vmu2)%*%solve(s22)),1,sum)
vF2<- (n2-nvar2)*vF2/((n2-1)*nvar2)
```

```{r modelos, message=F}
# aqu estão as modelagens

#lda.fit = lda(Reg~DGAD+DGM, dados2)

# Selecionando as amostras. Selecionei 25 observações de cada grupo para montar o treinamento do modelo

treinog1 <- sort(sample(1:50,25,replace=FALSE))
treinog2 <- sort(sample(51:100,25,replace=FALSE))
treino <- c(treinog1,treinog2)

# Amostra treino
#atrein <- iris[treino,]

# Utilizando a função lda
#m.X <- rbind(irisd[51:100,3:4],irisd[101:150,3:4])
#Sp = rep(c("VE","VI"), rep(50,2))
#m.Iris <- data.frame(m.X,Sp)
#table(m.Iris$Sp[treino])
#result.ad <- lda(Sp~., m.Iris, prior = c(1,1)/2,subset = treino)

# as prioris tem de ser diferentes. Custo iguais

result.ad <- lda(dados$Reg~., dados[,c(3,4)], prior = c(1,1)/2,subset = treino)
# coeficientes da função discriminante
# result.ad$scaling
# predizendo os grupos na amostra teste
pred<-predict(result.ad, dados[-treino, c(3,4)])$class
# função discriminante
y <-predict(result.ad, dados[-treino, c(3,4)])$x 
# Pegando a amostra teste
data.teste <- dados[-treino,1]
# Tabela de classificação
tc <- table(data.teste,pred)
#matriz de confusão
#confusionMatrix(tc)

#xtable(tc)

```

\setlength{\parindent}{3em}
\doublespacing

1. Introdução

\newpage

2. Análise Descritiva

A tabela 1, apresenta mostra algumas medidas resumo para as vaiáveis DGAD e DGM separadas por região (Alasca e Canadá).


```{r}
#xtable(tab_resumo_regiao)
```

\begin{table}[ht]
\centering
\caption{Medidas Resumo das variáveis por região}
\bgroup
\def\arraystretch{1.0}
\begin{tabular}{rlllllllll}
  \hline
 & Região & n & Media & Variancia & Desvio Padrao & CV(\%) & Minimo & Mediana & Maximo \\ 
  \hline
\multirow{2}{*}{DGAD} & Alasca & 50 & 98,38 & 260,608 & 16,143 & 16,409 & 53 & 99 & 131 \\ 
   & Canadá & 50 & 137,46 & 326,09 & 18,058 & 13,137 & 90 & 140 & 179 \\ \midrule
\multirow{2}{*}{DGM} & Alasca & 50 & 429,66 & 1399,086 & 37,404 & 8,706 & 355 & 427,5 & 511 \\ 
   & Canadá & 50 & 366,62 & 893,261 & 29,887 & 8,152 & 301 & 369,5 & 438 \\ \bottomrule
   \hline
\end{tabular}
\egroup
\end{table}


A partir da Figura 1, temos o gráfico de dispersão entre as variaveis, separadas por Região (Alasca e Canadá), iremos considerar a variavel Região com o mesmo significado de Grupo neste presente trabalho. Podemos observar que os indíviduos (objetos) do Canáda tendem a ter um diâmetro (em mm) da guelra durante a fase de água doce maior que os indivíduos do Alasca e na durante a fase no Mar tendem a ter um diametro menor (em mm). Podemos ver que olharmos separadamente os dois grupos, vemos que existe uma correlação levemente posivita entre os índividuos do Canadá, e levemente negativa para os índividuos do Alasca. Vale ressaltar que se considerarmos ambos os Grupos, parecer haver uma correlação negativa entre as variaveis.

```{r,fig.cap=c("Figura 1: Gráfico de dispersão entre os diâmetros da guelra de salmões em água doce e no mar"), fig.pos = '!h',fig.height=3}
#LINHA DE REGRESSAO PARA AMBOS OS GRUPOS
grid.draw(cbind(ggplotGrob(d1),
                ggplotGrob(d2),size = "first"))
```

\vspace{1cm}

O salmão nasce em rios e lagos de água doce, e só na maturidade, cerca de 2 a 5 anos, seguem em direção ao mar, a partir dos box-plot encontrado na Figura 2, notamos que o diâmetro da guelra é relativamente maior na água doce para os índividuos de ambos os grupos, podemos notar isso também na distribuição de densidade na Figura X, fato que é reforçado pelas tabela de medidas Tabela X., que reforça a ideia incial que estes resultados são esperados já que o salmão nasce em rios e lagos de água doce. 

Podemos observar também nos box-plot, que o diametro das guelras para o salmão do canadá  é consideravelmente maior do que os do Alasca, já durante a fase no mar, o diametro das guelras do Alasca é maior que do Canadá. Para ambas as variáveis,(DGAD, DGM) é possível notar uma sobreposição em boa parte da distribuições apresentadas Figura 3. As distribuições parecem ser levemente assimétricas, mais evidente para o diâmetro da guelra no mar de indivíduos do Canadá, e menos evidente para diâmetro da guelra na água doce de indivíduos do Alasca.

```{r,fig.cap=c("Boxplots por grupo"), fig.pos = '!h', fig.height=3}
grid.arrange(b1,b2, nrow=1, ncol=2)
```

```{r,fig.cap=c("Figura 3: Distribuição estimada por grupo"), fig.pos = '!h', fig.height=3}
grid.draw(cbind(ggplotGrob(g1),
                ggplotGrob(g2),size = "first"))+ theme(legend.position = "bottom") 
```

Podemos observar na Figura 4. que para cada variavel DGAD e DGM foi realizado um gráfico de quantil-quantil para cada Grupo (Canadá e Alasca), vemos que para o diâmetro da guelra na fase em água doce de indíviduos do Alasca, os pontos se comportaram de maneira razoavel em torno da linha de referência, não apresentando sinais anormais, diferentemente dos outros três gráficos que apresentam uma sistematização em torno da linha de referência, descartando a suposição de normalidade. Portanto consideremos apenas a suposição de normalidade para o diâmetro da guelra em água doce, que são os índivíduos do Alasca, já que existe uma leve tendência no qual o ajuste é consideravelmente razoavel.


```{r,fig.cap=c("Figura 4: Quantil-quantil para cada Grupo"),fig.width=8, fig.height=5.5,fig.pos = '!h'}
library(car)
#Por grupos - quantis-quantis
grupo=dados$Reg
dgad =dados$DGAD
dgm = dados$DGM

par(mfrow=c(2,2))
qqPlot(scale(dgad[grupo=="Alasca"]),dist="norm",mean=0,sd=1,col.lines="red",grid="FALSE",xlab="quantil da N(0,1)",ylab="Quantil da distriuição amostral",cex=1.2,id.cex=1.2,main="Fase em água doce - Alasca")
qqPlot(scale(dgm[grupo=="Alasca"]),dist="norm",mean=0,sd=1,col.lines="red",grid="FALSE",xlab="quantil da N(0,1)",ylab="Quantil da distriuição amostral",cex=1.2,id.cex=1.2,main="Fase no mar - Alasca")
qqPlot(scale(dgad[grupo=="Canadá"]),dist="norm",mean=0,sd=1,col.lines="red",grid="FALSE",xlab="quantil da N(0,1)",ylab="Quantil da distriuição amostral",cex=1.2,id.cex=1.2,main="Fase em água doce - Canadá")
qqPlot(scale(dgm[grupo=="Canadá"]),dist="norm",mean=0,sd=1,col.lines="red",grid="FALSE",xlab="quantil da N(0,1)",ylab="Quantil da distriuição amostral",cex=1.2,id.cex=1.2,main="Fase no mar - Canadá")
```


No gráfico abaixo podemos ver que a normalidade bivariada não parece ser uma suposição razoavel para nenhum dos grupos, porque além da sistematização em torno da linha de referência e existem  pontos fora do gráfico de envelope. Canadá particularmente a forma dos seus pontos se comportam de maneira concava, mesmo apresentando pontos fora.


```{r, fig.height=4.5,fig.width=9,fig.cap=c(" Gráfico de quantil-quantil com envelopes para a distância de Mahalanobis; A) Alasca, B) Canadá"),fig.pos = '!h'}
library(car)
par(mfrow=c(1,2))

car::qqPlot(vF,dist="f",df1=nvar,df2=n-nvar,col.lines="red",grid="FALSE",xlab="Quantil da distribuição F",ylab="Forma quadrática",cex=1.2,id.cex=1.2, main=" A) Alasca")

car::qqPlot(vF2,dist="f",df1=nvar2,df2=n2-nvar2,col.lines="red",grid="FALSE",xlab="Quantil da distribuição F",ylab="Forma quadrática",cex=1.2,id.cex=1.2, main="B) Canadá")
```


\newpage

3. Análise Inferencial

\newpage

4.Conclusões


5. Bibliografia

- Azevedo, C. L. N. (2017). Notas de aula sobre análise multivariada de dados http://www.ime.unicamp.br/~cnaber/Material_AM_2S_2017.htm


- Johnson, R. A. & Wichern, D. W. (2007). Applied Multivariate Statistical Analysis. 6 a edição, Upper Saddle River, NJ: Pearson Prentice Hall.
